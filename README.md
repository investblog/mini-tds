# mini-tds

Минимальный Cloudflare Worker для мобильного гео-редиректа. Акцент сделан на
простоте: все рабочие правила лежат в `config/routes.json` и подхватываются на
этапе сборки, поэтому воркер не зависит от KV и всегда использует актуальный
маршрутизатор.

## Что делает воркер

1. Пропускает любые не-`GET` запросы напрямую на origin.
2. Собирает данные из `CF` (страна) и заголовков (`User-Agent`, `Sec-CH-UA-*`).
3. Определяет тип устройства (desktop / mobile / tablet) и является ли запрос
   поисковым ботом.
4. Ищет первое правило из `config/routes.json`, которое подходит по стране,
   устройству, бот-флагу и пути (поддерживаются `*`-паттерны и RegExp).
5. Формирует конечный URL, умеет доклеивать путь, пробрасывать query и вытягивать
   первый сегмент пути в произвольный параметр.
6. Отдаёт 30x-редирект. Если правило не найдено — прозрачно проксирует запрос.

## Структура `config/routes.json`

Каждое правило включает:

- `match.path` — список масок (`/casino/*`), которые должны совпасть с
  `pathname`.
- `match.pattern` — дополнительные регулярные выражения (опционально).
- `match.countries` — ISO-коды стран (опционально).
- `match.devices` — допустимые устройства (`mobile`, `desktop`, `tablet`, `any`).
- `match.bot` — если `false`, правило игнорирует поисковых ботов.
- `target` — базовый URL редиректа.
- `appendPath` — добавить оригинальный путь в конец `target`.
- `forwardQuery` — пробросить исходный query-string.
- `extraParams` — дополнительные параметры. Ключи, начинающиеся с `__`, зарезервированы
  для служебных опций: например, `__pathToParam` указывает, в какой query-параметр
  положить первый сегмент пути, а `__stripPrefix` — что отрезать перед извлечением.
- `trackingParam` / `trackingValue` — быстрый способ добавить трекинговую метку.

Измените файл `config/routes.json` под ваши нужды и заново задеплойте воркер.

## Локальный запуск

```bash
npm install
npm run dev
```

Воркер стартует на `http://127.0.0.1:8787`. Меняйте заголовки `User-Agent` и
`Sec-CH-UA-Mobile`, чтобы тестировать разные сценарии.

## Деплой

```bash
npm run deploy
```

Обновите `wrangler.toml`, чтобы привязать воркер к нужному домену/маршруту.

## Дополнительно

Скрипт `scripts/upload-config.sh` оставлен для совместимости: он отправляет
`config/config.json` в KV с биндингом `CONFIG`. Если вы хотите продолжать вести
«тяжёлую» конфигурацию в KV или синхронизировать её с другими системами,
используйте этот файл и скрипт.
