# mini-tds

Минимальная TDS/клоака на базе Cloudflare Workers. Скрипт позволяет гибко управлять
распределением трафика по набору правил, вынесенных в конфигурацию, и автоматически
прокидывает метки в конечный URL.

## Возможности

- Поддержка Cloak + TDS: можно отдавать «белую» страницу ботам и перенаправлять реальных
  пользователей на разные лендинги.
- Сопоставление по множеству параметров: путь, query, заголовки, источник перехода,
  страна, язык, тип устройства.
- Гибкая передача параметров в целевой URL (оригинальный query, собственные метки).
- Маршрутизация конфигурируется через `config/routes.json`, без правки кода Worker.

## Структура проекта

```
.
├── config/
│   └── routes.json        # Основная конфигурация правил TDS/клоаки
├── src/
│   └── worker.ts          # Обработчик Cloudflare Worker
├── package.json           # Скрипты и dev-зависимости
├── tsconfig.json          # Настройки TypeScript
├── wrangler.toml          # Конфигурация деплоя Worker
└── README.md
```

## Конфигурация правил

Файл `config/routes.json` описывает набор правил. Каждое правило содержит блок `match`
(условия применения) и действие (`target` для редиректа или `response` для отдачи
контента).

Поддерживаемые условия в `match`:

- `path` — список путей. Поддерживаются шаблоны с `*` (например, `/promo/*`).
- `countries` — ISO-коды стран (используются данные Cloudflare `request.cf.country`).
- `languages` — языки из заголовка `Accept-Language`.
- `devices` — `mobile`, `desktop`, `tablet`, `bot` (определяются по `User-Agent`).
- `query` — ключи и допустимые значения query-параметров.
- `headers` — подстрочные совпадения значений заголовков.
- `referrers` — подстрочные совпадения хоста источника трафика.

Для действия доступны настройки:

- `target` — конечный URL редиректа.
- `response` — объект с `status`, `body`, `headers` (используется для белой страницы).
- `appendPath` — добавлять оригинальный путь к `target`.
- `stripPathPrefix` — убрать указанный префикс из исходного пути перед добавлением.
- `forwardQuery` — `true` (прокидывать весь query) или список ключей.
- `extraParams` — объект с дополнительными query-параметрами.
- `trackingParam`/`trackingValue` — параметр и значение для передачи ID маршрута
  (если `trackingValue` не задан, используется `id`).
- `status` — HTTP-статус редиректа (по умолчанию `302`).

`fallback` описывает поведение по умолчанию, если ни одно правило не совпало (обычно —
редирект на основной сайт или заглушка).

## Локальная разработка

```bash
npm install
npm run dev
```

Команда `npm run dev` запускает `wrangler dev` и поднимает локальный Worker на
`http://127.0.0.1:8787`. Чтобы протестировать различные сценарии, изменяйте заголовки и
параметры запроса.

Для проверки типов используйте `npm run typecheck`.

## Деплой в Cloudflare

1. Установите `wrangler` (`npm install -g wrangler`) или используйте локально.
2. Аутентифицируйтесь: `npx wrangler login`.
3. При необходимости измените `wrangler.toml` (имя Worker, маршруты, переменные окружения).
4. Задеплойте Worker: `npm run deploy` или `npx wrangler publish`.

## Кастомизация

- Добавляйте/изменяйте правила в `config/routes.json`. Изменения вступят в силу после
  деплоя.
- Для хранения конфигурации вне кода можно перенести JSON в KV Namespace и загрузить его
  в рантайме (не входит в базовый пример, но Worker легко адаптировать).
- При необходимости можно подключить дополнительные проверки (например, по IP или
  пользовательским cookies) — достаточно расширить структуру `match` и логику в
  `src/worker.ts`.

## Лицензия

Проект распространяется по лицензии MIT.
